name: Build and Release SageAttention Wheels

on:
  workflow_dispatch: # Allows manual trigger
  push:
    tags:
      - "v*" # Triggers on version tags

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        if: steps.check-tag.outputs.exists == 'false'
        uses: jlumbroso/free-disk-space@main
        with:
          # This might remove tools that we won't need anyway
          tool-cache: true
          android: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Check available disk space
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          echo "Available disk space:"
          df -h
          echo "Docker disk usage:"
          docker system df

      - name: Build Wheel in Docker
        run: |
          mkdir -p dist
          docker run --rm \
            -v "$(pwd)/dist:/output" \
            runpod/pytorch:2.8.0-py3.11-cuda12.8.1-cudnn-devel-ubuntu22.04 \
            bash -c '
              set -e
              apt-get update && apt-get install -y git
              pip install --no-cache-dir "triton==3.4.0" wheel
              git clone https://github.com/thu-ml/SageAttention /tmp/sage
              cd /tmp/sage
              git checkout v2.2.0
              # Target multiple architectures without needing a local GPU for compilation
              export TORCH_CUDA_ARCH_LIST="8.0;8.6;8.9;9.0"
              export MAX_JOBS=$(nproc)
              pip wheel --no-build-isolation --no-deps -w /output .
            '

      - name: Create Release and Upload Wheel
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.whl
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
